## 21. Целостность данных. Триггеры


### Корректность и целостность

**Корректность** - соответствие данных в бд реальному миру. Непровеяема.

**Целостность** - непротиворечивость данных в бд. Описывается набором правил. Проверяема.

**Проверка целостности**
- по умолчанию - по завершении оператора
- можно отложить до конца транзакции

При неудаче все изменения откатываются


### Ограничения целостности

- **Ограничение типа**

    Для конкретного типа есть множество допустимых значений

    (напр. ограгничение длинны varchar(n))


- **Ограничение атрибута**

    Множество значений, допустимых для атрибута (является следствием типа)
    
    (напр. not null атрибуты)


- **Ограничение отношения**

    Множество значений, допускаемое конъюнкцией предикатов, где предикат - это:

    Основной ключ

    Дополнительный ключ

    Внешний ключ

    Проверяемое условие
    - проверяется для каждого кортежа
    - лучше не ссылаться на другие записи (если такое вообще поддержано)


- **Ограничение базы данных**

    Множество значений, которые может принимать база данных в целом

    - Предикаты таблиц
    - Предикаты утверждений (напр. непустота сущности)


### Компенсирующие действия

При выполении update или delete может поменяться состояние сущности,
на которую ссылались какие-то другие сущности.

Возможные действия при этой ситуации:
- no action (мб дальше в транзакции мы починим этот констрейнт)
- cascade (не бесплатный, тк надо обновить много значений)
- restrict (сразу запретить, не должидаясь возможной починки)
- set null (не бесплатный, тк надо обновить много значений)
- set default (не бесплатный, тк надо обновить много значений)


### Триггеры

**Триггер** - действия, выполняемые при изменении данных.

- проверка целостности
- любые другие действия

Применения:
- уведомление пользователей
- обновление денормализованных данных
- аудит изменений
- компенсирующие действия

Триггер может выполняться до/после/вместо изменения, 
для каждой строки или для всего выражения.
Также триггер может ссылаться на любые другие таблицы, обновлять их итд.

Простые триггеры, состоящие из одного выражения,
в теории могут работать на разных субд.

Сложные триггеры почти не переносимы.
