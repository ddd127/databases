## 39. Репликация


**Репликация** - поддержание одинаковых данных на нескольких узлах

Типы репликации
- Синхронная (с распределенными транзакциями)
- Асинхронная

Схемы репликации
- С основной копией

    На запись доступна только основная копия,
    она же распространяет изменения в остальные копии, доступные на чтение

- Симметричная

    Чтение и запись возможны во все узлы,
    но есть проблема с противоречивыми изменениями.

    При этом реплики могут работать автономно, что большой плюс.


**Реализация репликации**

Все данные есть в протоколе транзакций, его и будем распространять.

Распространение

- Репликация операторов - реплики выполняют одни и те же изменения

    Плюсы:

    - нужно пересылать мало данных

    Минусы:

    - операторы должны быть детерминированы
    - надо учитывать порядок выполения транзакций

- Репликация записей - пересылаем информацию об изменениях конкретных записей

    Плюсы:

    - все детерминировано, надо меньше думать

    Минусы:

    - нужно гонять большие объемы данных


Применения репликации:

- Вертикальное масштабирование (с основной репликой)

    Асимметричная схема с основной репликой
    - малое количество записей
    - большое количество чтений

    Прменение
    - Web-серверы


- Горизонтальное масштабирование (с симметричной схемой)

    Симметричная схема
    - большое число локальных для реплики операций
    - периодическая синхронизация

    Применение:
    - географическая распределенность
    - независимость по данным
    - непостоянная связь между репликами


- Повышение доступности

    Асимметричная схема
    - если не основная реплика умерла, то пофиг
    - если умерла основная, то leader election


- Резервное копирование

    Для того, чтобы сделать бекап, нужно какое-то состояние базы
    - что такое "текущее состояние"?
    - ждать окончания транзакций можно довольно долго

    Заведем себе асинхронную реплику
    - постоянная синхронизация
    - будем снимать бекап, останавливая реплику


- Преобразование данных ("неполноценная" репликация)

    Асимметричная схема
    - периодическая синхронизация
    - при репликации преобразуем данные

    Применение
    - изменение формата хранения
    - унификация данных
