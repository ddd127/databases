## 35. Оптимизация запросов. Выбор структуры исполнения запроса

### Сеть операций

Итоговый граф действий называется сетью операций.

Аргументы операции - базовые таблицы и результаты других операций

Результат операции - либо окончательный результат, 
либо аргумент другой операции

Это именно сеть, а не дерево, 
потому что результат операции может использоваться не один раз

### Типы операций

- **Преобразователи**
  - Просматривают аргументы в процессе работы
  - Фильтр, Вложенный цикл

- **Контейнеры**
  - Загружают аргументы
  - Сохраняют результаты (мб на диске)
  - Сортировка

**Курсор** - один из интерфейсов между блоками

- open() - открыть курсор
- fetch() - получить следующую запись
- reset() - переоткрыть курсор
- close() - закрыть курсор


### Конкретные операции

- **Фильтр**

    - Преобразователь
    - O(n) по времени, O(1) по памяти
    - Селективен (с разной степенью)


- **Проекция**

    - Преобразователь/контейнер (в зависимости от упорядоченности)
    - O(n) по времени, O(1)/O(n) памяти (в зависимости от упорядоченности)
    - Требует упорядоченности входа (либо сам упорядочивает)
    - Сохраняет упорядоченность выхода (если она была)


- **Сортировка**

    - Контейнер
    - В памяти / во внешней памяти
    - O(n log n) по времени
    - Выход упорядочен
    - Очень разное реальное время исполнения в зависимости от объема


- **Просмотр таблиц**

    - И преобразователь, и контейнер
    - O(n) по времени
    - Full scan / Index / Cluster index


- **Полное объединение**

    - Преобразователь
    - O(n) по времени, O(1) по памяти


- **Объединение, Пересечение, Разность**

    - Преобразователь/контейнер (в зависимости от упорядоченности)
    - O(n) по времени, O(1)/O(n) по памяти (в зависимости от упорядоченности)
    - Сохраняет упорядоченность выхода (если она была)


- **Соединение: Вложенный перебор**

    - Преобразователь
    - Перебор left, для каждого - перебор right
    - O(left * right) по времени, O(1) по памяти
    - Сохраняет упорядоченность (если она была по left, мб добавится по right)


- **Соединение: Поиск по дереву**

    - Преобразователь
    - Перебор left, получение по индексу right
    - O(max(left * log right, result)) по времени, O(1) по памяти
    - Сохраняет упорядоченность (если она была по left, мб добавится по right)


- **Соединение: Поиск по хешу**

    - Преобразователь (мб + контейнер, если нет хеш индекса)
    - Перебор left, получение по хешу right
    - O(max(left + right, result)) по времени, O(1) (или O(right)) по памяти
    - Сохраняет упорядоченность по left (если она была)


- **Соединение: Слияние**

    - Преобразователь
    - Классический merge упорядоченных последовательностей
    - O(max(left + right, result)) по времени
    - Требует упорядоченности входов
    - Гарантирует упорядоченность выхода
