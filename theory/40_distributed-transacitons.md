## 40. Распределенные транзакции

**В транзакции участвует несколько узлов**
- либо на всех зафиксирована
- либо на всех откачена

**Сбои**
- участников (умер узел)
- коммуникации (умерло соединение)

**Двухфазная фиксация**

- Выбирается координатор (обычно тот узел, на который пришел запрос)
- Координатор дошел до коммита
- Broadcast "правда ли, что все участники готовы коммитить?"
- Ожидаем подтверждения всех
- Broadcast "коммитим"
- Ожидаем подтверждения всех


**Проблема двух генералов**

Поскольку у двух узлов нет способа гарантированно договориться
за конечное число сообщений,
поэтому применяются разнообразные эвристики и ретраи.


**Обработка сбоев координатора**

- до принятия решения => откат

    Если координатор (или связь с ним) умерли до принятия решения,
    просто откатываем транзакцию


- принятие решения => запись в протокол транзакций

    Если координатор принял решение, то он записывает его в лог 
    и после восстановления рассылает его всем участникам транзакции

- после принятия решения => выполнение решения

    Если решение уже принято, то оно записано в лог и мы его разошлем


**Обработка сбоев участников**

- до получения решения => спросим у координатора
- получение решения => запись в протокол транзакций
- после получения решения => отправим координатору ок


Отметим, что координатору нужно помнить решение между его принятием
и получением всех подтверждений.

**Протокол предполагаемой фиксации**

Если мы решили зафиксировать транзакцию - фиксируем и забываем про неё.
На вопросы про неизвестные транзакции отвечаем, что они зафиксированы.

Тратим память только для тех транзакций, которые были откачены.

Аналогично

**Протокол предполагаемого отката**

Аналогично, но запоминаем только зафиксированные.


На практике протокол предполагаемого отката надежнее, 
поскольку если сбой координатора произошел на первой фазе,
он может забыть про транзакцию, а другим узлам сказать, что она подтверждена.
