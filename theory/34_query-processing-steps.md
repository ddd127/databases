## 34. Этапы обработки запроса. Перезапись запросов

Общая схема обработки запроса выглядит примерно так:

1. **Разборщик запроса**

    На вход разборщику приходит sql, 
    разборщик преобразует его в реляционную алгебру.

2. **Планировщик запроса**

    Планировщик оптимизирует схему исполнения на языке реляционной алгебры 
    и для каждого узла указывает метод исполнения

3. **Исполнитель запроса**

    Выполняет действия, переданные ему планировщиком

4. **Источник данных**

    Предоставляет исполнителю запроса данные, которое тот потребует


### Перезапись запроса

**Перезапись** - это этап, который выполняется над запросом всегда, 
до начала любых оптимизационных действий, 
независимо от того, что именно это за запрос. 
Считается, что перезапись никогда не делает хуже (а часто даже делает лучше).


- Преобразование подзапросов
  - запись в реляционном исчислении
  - вынос кванторов
  - преобразование в алгебру

- Преобразование соединений
  - внешние соединения
  - декартовы соединения

- Постараемся сделать все филтрации до проекций

- Замена повторной фильтрации на одинарную

- Замена повторной проекции на внешнюю

- Используя дистрибутивность преобразуем фильтрации и проекции

- Используя коммутативность и ассоциативность выбираем наиболее оптимальный порядок

- Замыкаем предикаты
    Такая оптимизация позволяет протолкнуть больше условий

- Преобразуем предикаты в КНФ или ДНФ
    
    Если формула получается слишком большая, то не преобразуем

- Семантические оптимизации
    
    При наличии доп ограничений не эквивалентные в общем случае запросы 
    могут быть эквивалентны в частном случае 
    (например, при наличии внешних ключей)


### Планировщик

Планировщик стоит оптимальную схему исполнения, 
перебирая различные варианты, на основе конкретных данных запроса
выбирая структуру и методы, пользуясь моделью оценки для принятия решений.

Выбор структуры и метода:

- преобразование запроса
- порядок выполнения операций
- порядок соединений
- конкретные методы выполенения каждой операции

Оценка плана (на основе статистики по данным и запросам):

- стоимость операции
- размер операндов
- размер результата
