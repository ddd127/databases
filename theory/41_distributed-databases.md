## 41. Распределенные базы данных. Цели и проблемы

### Цели распределения

**Децентрализация**

- Локальная независимость

    Узел должен уметь функционировать в изоляции, =>


- Отстутствие центрального узла

    Не должно быть одного узявимого места, падение которого ломает все


- Непрерывное функционирование

    Надежность (всегда можем обратиться к базе)

    Доступность (узел умеет отвечать на все запросы)


- Равноправие узлов

    Допустим выбор временного координатора


**Прозрачность**
- Независимость от расположения

    Работать можно на любом узле

    От любого узла ожидаются одинаковые результаты запроса


- Независимость от фрагментации

    Пользователь не должен знать, на каком узле находятся данные

    Конкретная география исполнения запроса инкапсулирована внутри бд


- Независимость от репликации

    Автоматическая поддержка репликации

    Бд может реплицироваться с любого узла


**Распределенные транзакции**

Поскольку один запрос может затрагивать несколько узлов,
все они должны иметь согласованное представление о том,
какие данные этот запрос видит и будет ли он в итоге применен.

Если хотя бы один узел отказывается применять транцакцию,
она должна быть откачена на всех узлах согласованно.


**Независимости**

- независимость аппаратуры (write once, run anywhere)
- независимость от ОС (конвертация переводов строк, например)
- независимость от сети (разные узлы - разные соединения)
- независимость от типа СУБД (хочется, чтобы работало с любыми одновременно)

Очевидно, что не все требования разумно выполнимы в реальном мире


## Проблемы распределения

**CAP-теорема**

- Consistency - информация на разных узлаг согласована
- Availability - система отвечает на запросы
- Partition tolerance - связи между узлами могут обрываться

Теорема говорит о том, что одновременно можно поддержать максимум 2 из 3

Однако в реальном мире эти свойства не совсем бинарные, 
так что мы можем выполнить часть одного из свойств и это может быть ок.

Например, в случе, если потеряна связь с больше чем половиной узлов,
Узел может отказаться выполнять запросы - мы частично нарушаем Availability


**Partition tolerance**

В случае обрыва связи:

- либо частичный отказ от Availability - функционирует одна часть системы
- либо частичный отказ от Consistency - надо как-то мержить состояния

Пока система не разделена, есть полные Availability и Consistency


**BASE подход**

- Basically Available - сбой узла приводит к отказу только для части пользователей
- Soft-state - могут происходить изменения без внешнего вмешательста (напр. merge после разрыва)
- Eventual consistency - система может быть временно не согласована (напр. пока разрыв)


**Разрешение несогласованности**

- При чтении - замедлили чтение
- При записи - замедлили запись
- Асинхронно - вроде всё ок, но система дольше остается несогласованной.
